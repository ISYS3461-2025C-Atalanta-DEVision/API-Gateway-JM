server:
  port: 8080

spring:
  application:
    name: api-gateway

  # Redis Configuration (for token revocation cache)
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 2000ms

  cloud:
    gateway:
      # Enable service discovery based routing
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      # Default filters applied to all routes
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials Access-Control-Allow-Methods Access-Control-Allow-Headers Access-Control-Expose-Headers Access-Control-Max-Age, RETAIN_FIRST

      # Global CORS configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins:
              - "http://localhost:3000"
              - "http://localhost:5173"
              - "http://127.0.0.1:3000"
              - "http://127.0.0.1:5173"
            allowedMethods:
              - GET
              - POST
              - PUT
              - PATCH
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            exposedHeaders:
              - "Authorization"
              - "Content-Type"
            allowCredentials: true
            maxAge: 3600

# Eureka Client Configuration (with authentication)
eureka:
  client:
    service-url:
      defaultZone: http://${EUREKA_USERNAME:eureka}:${EUREKA_PASSWORD:eureka-secret-2024}@localhost:8761/eureka/
    fetch-registry: true
    register-with-eureka: true
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${random.uuid}

# Internal API Key for service-to-service communication
internal:
  api-key: ${INTERNAL_API_KEY:devision-internal-api-key-2024-secure}

# JWT Configuration (must match auth-service)
jwt:
  secret: ${JWT_SECRET:devision-jm-auth-service-secret-key-2024-must-be-at-least-256-bits-long-for-hs256}
  access-token-expiration: 900000      # 15 minutes in milliseconds
  refresh-token-expiration: 604800000  # 7 days in milliseconds
  issuer: devision-jm-auth-service

# Circuit Breaker Configuration
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
    instances:
      authServiceCircuitBreaker:
        baseConfig: default

  timelimiter:
    configs:
      default:
        timeoutDuration: 3s

# Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,metrics
  endpoint:
    gateway:
      enabled: true
    health:
      show-details: always

# CORS Configuration
# In production, set CORS_ALLOWED_ORIGINS to your frontend URL(s)
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000,http://127.0.0.1:5173}

# Logging Configuration
logging:
  level:
    root: INFO
    com.devision.jm.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    reactor.netty: INFO

---
# Production Profile
spring:
  config:
    activate:
      on-profile: prod

  data:
    redis:
      host: ${REDIS_HOST:redis}
      port: ${REDIS_PORT:6379}

eureka:
  client:
    service-url:
      defaultZone: http://${EUREKA_USERNAME:eureka}:${EUREKA_PASSWORD:eureka-secret-2024}@${EUREKA_HOST:eureka-server}:8761/eureka/

# CORS - Must be set for production frontend URL
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS}

logging:
  level:
    root: WARN
    com.devision.jm.gateway: INFO
