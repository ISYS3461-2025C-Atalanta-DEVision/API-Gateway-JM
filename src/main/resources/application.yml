server:
  port: 8080
  # Increase max request size for file uploads
  max-http-request-header-size: 64KB

spring:
  application:
    name: api-gateway

  # WebFlux multipart support for file uploads through gateway
  webflux:
    multipart:
      max-in-memory-size: 50MB
      max-disk-usage-per-part: 50MB
      max-parts: 10

  codec:
    max-in-memory-size: 50MB

  # Enable static resource serving for OpenAPI spec
  web:
    resources:
      static-locations: classpath:/static/

  cloud:
    gateway:
      # Enable service discovery based routing
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
          # Exclude kafka-registrar from automatic routing (it's not an HTTP service)
          predicates:
            - name: Path
              args:
                pattern: "'/'+serviceId+'/**'"
          include-expression: "!(serviceId.equals('kafka-registrar'))"

      # Default filters applied to all routes
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials Access-Control-Allow-Methods Access-Control-Allow-Headers Access-Control-Expose-Headers Access-Control-Max-Age, RETAIN_FIRST

      # Global CORS configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins:
              - "http://localhost:3000"
              - "http://localhost:5173"
              - "http://localhost:5174"
              - "http://127.0.0.1:3000"
              - "http://127.0.0.1:5173"
              - "http://127.0.0.1:5174"
            allowedMethods:
              - GET
              - POST
              - PUT
              - PATCH
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            exposedHeaders:
              - "Authorization"
              - "Content-Type"
            allowCredentials: true
            maxAge: 3600

# Eureka Client Configuration (with authentication)
eureka:
  client:
    service-url:
      defaultZone: http://${EUREKA_USERNAME:eureka}:${EUREKA_PASSWORD:eureka-secret-2024}@localhost:8761/eureka/
    fetch-registry: true
    register-with-eureka: true
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${random.uuid}

# Internal API Key for service-to-service communication (JM microservices)
internal:
  api-key: ${INTERNAL_API_KEY:devision-internal-api-key-2024-secure}

# External API Key for partner systems (Job Applicant team)
# Share this key with JA team for service-to-service communication
external:
  api-key: ${EXTERNAL_API_KEY:devision-ja-external-api-key-2024}
  endpoints:
    # Company Public Profile Data (Requirement #1)
    - /profile-service/api/profiles
    # Job Post Data (Requirement #2)
    - /jobpost-service/api/job-posts
    # Subscription Payment API (Requirement #3)
    # All payment endpoints accessible with API key except /internal/**
    - /payment-service/api/payments/subscriptions/**
    - /payment-service/api/payments/transactions/**
    - /payment-service/api/payments/premium/**

# JWT Configuration (must match auth-service)
jwt:
  secret: ${JWT_SECRET:devision-jm-auth-service-secret-key-2024-must-be-at-least-256-bits-long-for-hs256}
  access-token-expiration: 900000      # 15 minutes in milliseconds
  refresh-token-expiration: 604800000  # 7 days in milliseconds
  issuer: devision-jm-auth-service

# Gateway Configuration
gateway:
  # Public endpoints that don't require authentication
  # Add new public endpoints here - no code changes needed
  # Note: Paths include service prefix when using Eureka discovery (e.g., /auth-service/...)
  public-endpoints:
    - /actuator/health
    - /actuator/info
    # Swagger/OpenAPI endpoints
    - /swagger-ui.html
    - /swagger-ui/**
    - /v3/api-docs/**
    - /webjars/**
    - /openapi.yaml
    # Auth service public endpoints (with service prefix for Eureka routing)
    - /auth-service/api/auth/login
    - /auth-service/api/auth/register
    - /auth-service/api/auth/refresh
    - /auth-service/api/auth/activate/**
    - /auth-service/api/auth/forgot-password
    - /auth-service/api/auth/reset-password/**
    - /auth-service/api/auth/countries
    - /auth-service/api/auth/validate
    # OAuth2 endpoints
    - /auth-service/oauth2/**
    - /auth-service/login/oauth2/**
    # Legacy paths (without service prefix)
    - /api/auth/login
    - /api/auth/register
    - /api/auth/refresh
    - /api/auth/activate/**
    - /api/auth/forgot-password
    - /api/auth/reset-password/**
    - /api/auth/countries
    # Company registration
    - /api/companies/register
    - /company-service/api/companies/register
    # Public job listings (Job Post Service)
    - /api/job-posts/public/**
    - /jobpost-service/api/job-posts/public/**
    # Stripe webhook (Payment Service) - must be public for Stripe to call
    - /payment-service/api/payments/webhooks/stripe
    - /api/payments/webhooks/stripe

  # Admin-only endpoints (require ADMIN role)
  # Add admin endpoints here - users without ADMIN role get 403 Forbidden
  admin-endpoints:
    - /api/admin/**
    - /auth-service/api/admin/**

# Circuit Breaker Configuration
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
    instances:
      authServiceCircuitBreaker:
        baseConfig: default

  timelimiter:
    configs:
      default:
        timeoutDuration: 3s

# Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,metrics
  endpoint:
    gateway:
      enabled: true
    health:
      show-details: always

# CORS Configuration
# In production, set CORS_ALLOWED_ORIGINS to your frontend URL(s)
cors:
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:5173,http://localhost:5174,http://127.0.0.1:3000,http://127.0.0.1:5173,http://127.0.0.1:5174}

# SpringDoc OpenAPI / Swagger Configuration
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    urls:
      - name: DevVision Job Manager API
        url: /openapi.yaml
    display-request-duration: true
    operations-sorter: alpha
    tags-sorter: alpha
  show-actuator: false

# Logging Configuration
logging:
  level:
    root: INFO
    com.devision.jm.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    reactor.netty: INFO

